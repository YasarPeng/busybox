# ä½¿ç”¨ Alpine Linux ä½œä¸ºåŸºç¡€é•œåƒä»¥å‡å°ä½“ç§¯
FROM alpine:3.18

# æ·»åŠ æ ‡ç­¾ä¿¡æ¯
LABEL maintainer="pengyongshi" \
    description="Multi-tool container with MySQL, Redis, RabbitMQ, MinIO, etcdctl and network tools" \
    version="1.1"

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV TZ=Asia/Shanghai

# è®¾ç½®ä¸»æœºå
ENV HOSTNAME=laiye-tools-debug

# ä¿®æ”¹ apk æºä¸ºé˜¿é‡Œäº‘é•œåƒ
# RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…æ‰€æœ‰å¿…éœ€çš„åŒ…ï¼Œåˆå¹¶ä¸ºå•å±‚ä»¥å‡å°é•œåƒå¤§å°
RUN apk add --no-cache \
    # åŸºç¡€å·¥å…·
    curl \
    wget \
    unzip \
    tar \
    bash \
    # ç½‘ç»œæŽ’æŸ¥å·¥å…·
    bind-tools \
    iproute2 \
    iputils-ping \
    busybox-extras \
    traceroute \
    nmap \
    tcpdump \
    mtr \
    # è¿›ç¨‹å’Œç³»ç»Ÿç›‘æŽ§å·¥å…·
    htop \
    iotop \
    lsof \
    strace \
    # æ–‡æœ¬ç¼–è¾‘å’Œå¤„ç†å·¥å…·
    vim \
    jq \
    yq \
    # æ•°æ®åº“å®¢æˆ·ç«¯
    mariadb-client \
    redis \
    # å…¶ä»–å·¥å…·
    ca-certificates \
    && rm -rf /var/cache/apk/*

# å®‰è£… MariaDB å®¢æˆ·ç«¯ä»¥æ”¯æŒ MySQL 8 çš„è®¤è¯æ–¹å¼
RUN apk add --no-cache mariadb-connector-c

# å®‰è£… RabbitMQ å®¢æˆ·ç«¯å·¥å…·
RUN apk add --no-cache rabbitmqctl || true

# å®‰è£… MinIO å®¢æˆ·ç«¯ (mc) - AMD64ç‰ˆæœ¬
RUN curl -sSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc \
    && chmod +x /usr/local/bin/mc

# å®‰è£… etcdctl å·¥å…· - AMD64ç‰ˆæœ¬
RUN curl -sSL https://github.com/etcd-io/etcd/releases/download/v3.5.25/etcd-v3.5.25-linux-amd64.tar.gz -o etcd.tar.gz \
    && tar -xzvf etcd.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.25-linux-amd64/etcdctl \
    && rm etcd.tar.gz \
    && chmod +x /usr/local/bin/etcdctl

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /apps

COPY ./apps /apps/

# æ·»åŠ æ¬¢è¿Žè¯­å¥åˆ°motd
RUN echo '' > /etc/motd \
    && echo 'ðŸ”§ æ¬¢è¿Žä½¿ç”¨ laiye-tools-debug è°ƒè¯•å·¥å…·ç®±ï¼' >> /etc/motd \
    && echo 'ðŸ“¦ åŒ…å«å·¥å…·: MySQLå®¢æˆ·ç«¯, Redis, RabbitMQ, MinIO, etcdctl, ç½‘ç»œè¯Šæ–­å·¥å…·' >> /etc/motd \
    && echo 'ðŸŒ ç½‘ç»œæ¨¡å¼: Host' >> /etc/motd \
    && echo 'ðŸš€ å¼€å§‹æ‚¨çš„è°ƒè¯•å·¥ä½œå§ï¼' >> /etc/motd \
    && echo '' >> /etc/motd

# åˆ›å»º .bashrc æ¥æ˜¾ç¤ºæ¬¢è¿Žè¯­å¥
RUN echo '# æ˜¾ç¤ºæ¬¢è¿Žè¯­å¥' > /root/.bashrc \
    && echo 'if [ -f /etc/motd ]; then' >> /root/.bashrc \
    && echo '    cat /etc/motd' >> /root/.bashrc \
    && echo 'fi' >> /root/.bashrc \
    && echo '' >> /root/.bashrc

# è®¾ç½®é»˜è®¤å‘½ä»¤
ENTRYPOINT ["/bin/bash"]