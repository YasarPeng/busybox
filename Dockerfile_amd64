# 使用 Alpine Linux 作为基础镜像以减小体积
FROM alpine:3.18

# 添加标签信息
LABEL maintainer="pengyongshi" \
    description="Multi-tool container with MySQL, Redis, RabbitMQ, MinIO, etcdctl and network tools" \
    version="1.1"

# 设置环境变量
ENV TZ=Asia/Shanghai

# 修改 apk 源为阿里云镜像
# RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# 安装所有必需的包，合并为单层以减小镜像大小
RUN apk add --no-cache \
    # 基础工具
    curl \
    wget \
    unzip \
    tar \
    bash \
    # 网络排查工具
    bind-tools \
    iproute2 \
    iputils-ping \
    busybox-extras \
    traceroute \
    nmap \
    tcpdump \
    mtr \
    # 进程和系统监控工具
    htop \
    iotop \
    lsof \
    strace \
    # 文本编辑和处理工具
    vim \
    jq \
    yq \
    # 数据库客户端
    mariadb-client \
    redis \
    # 其他工具
    ca-certificates \
    && rm -rf /var/cache/apk/*

# 安装 MariaDB 客户端以支持 MySQL 8 的认证方式
RUN apk add --no-cache mariadb-connector-c

# 安装 RabbitMQ 客户端工具
RUN apk add --no-cache rabbitmqctl || true

# 安装 MinIO 客户端 (mc) - AMD64版本
RUN curl -sSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc \
    && chmod +x /usr/local/bin/mc

# 安装 etcdctl 工具 - AMD64版本
RUN curl -sSL https://github.com/etcd-io/etcd/releases/download/v3.5.25/etcd-v3.5.25-linux-amd64.tar.gz -o etcd.tar.gz \
    && tar -xzvf etcd.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.25-linux-amd64/etcdctl \
    && rm etcd.tar.gz \
    && chmod +x /usr/local/bin/etcdctl

# 创建工作目录
WORKDIR /apps

COPY ./apps /apps/

# 设置默认命令
CMD ["/bin/bash"]